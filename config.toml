[detector]
# Включает детектор движения. В текущем ручном режиме отслеживания не используется.
use_motion = false

# Включает использование RKNN-детектора. Значение true пытается загрузить модель и использовать NPU. Значение false отключает детекцию, оставляя только трекер. Полезно для тестов производительности и UI без инференса. Если включено, при ошибке загрузки детектор отключится автоматически.
use_rknn = false

# Путь к файлу модели RKNN. Путь может быть относительным или абсолютным, и считается от рабочей директории запуска. Если файл не найден, загрузка конфигурации завершится ошибкой. Убедитесь, что модель скопирована рядом с бинарником или укажите полный путь. Для нескольких моделей меняйте только этот параметр.
rknn_model_path = "models/yolov8n_fp16.rknn"

# Коэффициент масштабирования входного изображения. Значение 1/255 нормализует вход в диапазон 0..1. Если модель ожидает другое масштабирование, меняйте этот параметр. При неверном масштабе точность сильно ухудшается. Используйте значение из пайплайна обучения модели.
rknn_scale = 0.0039215686

# Переключает порядок каналов BGR↔RGB. Включайте true, если модель обучалась на RGB. Оставляйте false, если модель ожидает BGR. Неверный порядок каналов приводит к отсутствию детекций. Проверьте порядок в вашем конвертере RKNN.
rknn_swap_rb = true

# Порог уверенности детекции. Чем ниже значение, тем больше ложных срабатываний. Чем выше значение, тем меньше пропусков, но больше «тишины». Для ночных сцен часто требуется уменьшение порога. Начните с 0.15–0.25 и подберите под свою камеру.
rknn_conf_threshold = 0.05

# Порог NMS для подавления перекрывающихся боксов. Меньшее значение сильнее объединяет боксы. Большее значение допускает больше боксов на один объект. Для плотных сцен увеличивайте, для шума уменьшайте. Параметр влияет на стабильность трекинга.
rknn_nms_threshold = 0.45

# Фильтр по классу. Значение -1 принимает все классы модели. Укажите индекс класса, если нужен только один тип объекта. Индексы соответствуют порядку классов в обучении модели. Неправильный индекс приведёт к отсутствию детекций. Используйте -1 для первичной диагностики.
rknn_class_id = -1


[motion_detector]
# Количество кадров истории для фоновой модели. Больше значение медленнее
# подстраивается под изменения сцены, но устойчивее к шуму.
history = 500

# Порог вариативности пикселя. Меньше значение чувствительнее к движению.
var_threshold = 6.0

# Обнаружение теней. При true в маске возможны полутоновые пиксели.
detect_shadows = false

# Минимальная площадь движения (в пикселях) для ROI.
min_area = 20

# Минимальная ширина/высота ROI, чтобы отбросить шум.
min_width = 8
min_height = 8

# Размытие маски движения для подавления шума (нечётное значение).
blur_size = 5

# Размер морфологического ядра.
morph_size = 3

# Количество эрозий/дилатаций для стабилизации маски.
erode_iterations = 1
dilate_iterations = 2


[manual_tracker]
# Максимальное количество одновременно отслеживаемых целей.
max_targets = 5

# Дополнительные пиксели, добавляемые к найденному ROI при клике.
click_padding = 6

# Дополнительный допуск для удаления цели при повторном клике.
remove_padding = 6

# Размер квадратного бокса, если flood fill не нашёл явный объект.
fallback_box_size = 40

# Максимально допустимая доля площади кадра для ROI (0..1).
max_area_ratio = 0.1

# Радиус поиска движущейся цели вокруг клика (пиксели).
motion_search_radius = 60

# Порог разницы яркости для поиска движения (0..255).
motion_diff_threshold = 15

# Допуски flood fill по яркости.
floodfill_lo_diff = 20
floodfill_hi_diff = 20

# Минимальный размер ROI для принятия.
min_area = 60
min_width = 10
min_height = 10

# Радиус поиска при попытке повторного захвата по шаблону.
search_radius = 60

# Порог совпадения шаблона (0..1) для успешного ре-захвата.
match_threshold = 0.7

# Обновлять шаблон при успешном трекинге.
update_template = true

# Максимальное время (мс) удержания цели при пропаже.
max_lost_ms = 1500

# Автоматически переназначать цель на ближайший трек, если она потеряна.
auto_reacquire_nearest = true

# Задержка (мс) до переназначения потерянной цели.
reacquire_delay_ms = 2000

# Параметры фильтра Калмана.
kalman_process_noise = 0.01
kalman_measurement_noise = 0.1

[tracker]
# Максимально допустимое количество пропущенных кадров для трека. Большее значение удерживает трек дольше. Меньшее значение быстрее удаляет потерянные цели. Для нестабильного видео лучше увеличить. Для динамичных сцен лучше уменьшить.
max_missed_frames = 60

# Максимальное количество одновременных целей. Ограничивает нагрузку и шум. Большие значения увеличивают нагрузку на CPU. Малые значения могут приводить к потере целей. Подбирайте под мощность устройства и плотность сцены.
max_targets = 50

# Минимальный IoU для сопоставления bbox между кадрами. Больший порог делает трекер строгим. Меньший порог позволяет склеивать более отдалённые боксы. Для быстрых объектов порог обычно ниже. Для стабильных сцен можно повысить.
iou_th = 0.15

# Включает режим ведущей цели. При true оставляет трек только для направления движения. При false отображаются все найденные цели. Полезно против «шлейфа» боксов. Для отладки лучше отключать.
leading_only = true

# Минимальная скорость для учёта направления. Чем выше значение, тем меньше «ложных» направлений. Чем ниже значение, тем чувствительнее выбор направления. Для медленных объектов уменьшайте. Для быстрых потоков увеличивайте.
leading_min_speed = 2.0

# Включение фильтра Калмана для предсказания траекторий при пропусках детекций.
use_kalman = true

# Шумы фильтра Калмана. Увеличивайте process_noise для более быстрой реакции,
# увеличивайте measurement_noise для более сильного сглаживания.
kalman_process_noise = 0.01
kalman_measurement_noise = 0.1


[static_rebind]
# Автоматическая перепривязка static bbox при потере цели. При true система пытается найти новую цель. При false статический bbox остаётся отцепленным. Полезно для ручного режима и отладки. Для автономной работы рекомендуется true.
auto_rebind = true

# Таймаут ожидания новой цели (мс). Большое значение дольше держит попытку перепривязки. Малое значение быстрее прекращает поиск. Для нестабильной сцены увеличивайте. Для быстрого отклика уменьшайте.
rebind_timeout_ms = 200

# Порог IoU для подтверждения связи static bbox с родительским. Большое значение требует точного совпадения. Малое значение допускает больше расхождений. При тряске камеры лучше уменьшить. При стабильной сцене можно повысить.
parent_iou_th = 0.85

# Порог score для повторной привязки. Большой порог снижает ложные перепривязки. Малый порог увеличивает вероятность ошибки. Если перепривязка слишком агрессивная, увеличьте. Если перепривязка не происходит, уменьшите.
reattach_score_th = 0.20


[overlay]
# Прозрачность HUD. Большое значение делает интерфейс более заметным. Малое значение делает интерфейс почти прозрачным. Слишком высокий HUD мешает обзору кадра. Подбирайте под яркость сцены и дисплей.
hud_alpha = 0.25

# Прозрачность невыбранных bbox при наличии активного static bbox. Большое значение оставляет боксы заметными. Малое значение делает их почти невидимыми. Полезно для снижения визуального шума. Подбирайте под количество объектов в сцене.
unselected_alpha_when_selected = 0.3


[smoothing]
# Окно сглаживания dynamic bbox. Большие значения дают плавность, но больше задержка. Малые значения дают резкость, но больше дрожание. Для быстрых объектов уменьшайте. Для стабильных объектов увеличивайте.
dynamic_bbox_window = 15


[merge]
# Максимальное количество bbox в одном кластере. Большие значения сильнее объединяют цели. Малые значения сохраняют больше отдельных целей. Для плотных сцен увеличивайте. Для разделённых объектов уменьшайте.
max_boxes_in_cluster = 1

# Порог IoU для определения соседних bbox. Высокий порог требует сильного перекрытия. Низкий порог объединяет более далёкие объекты. Если происходит склейка разных объектов — увеличьте. Если склейка не происходит — уменьшите.
neighbor_iou_th = 0.5

# Коэффициент расстояния центров bbox для объединения. Большее значение допускает дальние объединения. Меньшее значение делает объединение строгим. Для шума уменьшайте коэффициент. Для редких объектов можно увеличить.
center_dist_factor = 2.5

# Максимальная кратность площади объединённого bbox. Большое значение допускает большие расширения. Малое значение ограничивает рост бокса. Если объединённые боксы становятся слишком большими — уменьшите. Если объединение не происходит — увеличьте.
max_area_multiplier = 1.0


[rtsp]
# URL RTSP-потока. Ошибка в адресе приведёт к отсутствию видео. Чем стабильнее адрес, тем меньше неожиданных разрывов. Длинный URL не влияет на производительность, но усложняет отладку. Проверяйте доступность потока в стороннем плеере.
url = "rtsp://192.168.144.25:8554/main.264"

# Протоколы rtspsrc: 1=UDP, 4=TCP. UDP даёт меньшую задержку, но больше потерь. TCP надёжнее, но может давать большую задержку. Для нестабильной сети используйте TCP. Для минимальной задержки используйте UDP.
protocols = 1

# latency (мс) для rtspsrc. Большее значение сглаживает джиттер. Меньшее значение уменьшает задержку. Слишком малое значение может давать рывки. Подбирайте под качество сети.
latency_ms = 0

# Таймаут ожидания данных (мкс). Большое значение терпимее к сетевым задержкам. Малое значение быстрее обнаруживает проблемы. Для нестабильной сети увеличивайте. Для быстрого детекта разрывов уменьшайте.
timeout_us = 2000000

# Таймаут TCP (мкс). Большое значение снижает ложные рестарты. Малое значение ускоряет реакцию на проблемы. На шумных сетях увеличивайте. В стабильных сетях можно уменьшить.
tcp_timeout_us = 2000000

# Включение подробных логов RTSP-воркера. true выводит больше диагностических сообщений. false уменьшает шум в консоли. Для отладки включайте. Для продакшена оставляйте false.
verbose = false

[rtsp.watchdog]
# Таймаут отсутствия кадров (мс). Большое значение уменьшает ложные рестарты. Малое значение ускоряет восстановление. Для нестабильных камер увеличивайте. Для чувствительного мониторинга уменьшайте.
no_frame_timeout_ms = 1500

# Минимальная пауза между рестартами (мс). Большое значение защищает от «дребезга». Малое значение ускоряет восстановление. При частых перезапусках увеличьте. При долгих зависаниях уменьшите.
restart_cooldown_ms = 1000

# Стартовая «льгоа» после запуска (мс). Большое значение уменьшает ложные тревоги при старте. Малое значение ускоряет первый рестарт. При медленном старте системы увеличьте. При быстром старте можно уменьшить.
startup_grace_ms = 3000
